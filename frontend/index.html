<!DOCTYPE html>
<html>

<head>
    <title>SUNSCRIPT</title>
    <script src="dataset.js"></script>
    <script src="megafilter.js"></script>
    <script src="index.js"></script>
    <link rel="stylesheet" href="style.css">
    <script>
        function createTable(data, containerId, whitelistColumns = null) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`Container with id "${containerId}" not found`);
                return;
            }
            const existingTable = container.querySelector('table');
            if (existingTable) existingTable.remove();
            const table = document.createElement('table');
            table.className = "my_table"

            let headers = [...new Set(data.flatMap(obj => Object.keys(obj)))];
            if (whitelistColumns && Array.isArray(whitelistColumns)) {
                headers = []
                for (const c of whitelistColumns) {
                    headers.push(c)
                }
            }
            if (headers.length === 0) {
                table.innerHTML = '<tr><td>No data</td></tr>';
                container.appendChild(table);
                return;
            }

            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header
                headerRow.appendChild(th);
            });
            table.appendChild(headerRow);

            data.forEach(item => {
                const row = document.createElement('tr');
                headers.forEach(header => {
                    const cell = document.createElement('td');
                    cell.textContent = item[header] !== undefined ? item[header] : ' ';
                    row.appendChild(cell);
                });
                table.appendChild(row);
            });

            container.appendChild(table);
        }
        function shuffle(array) {
            let currentIndex = array.length;

            // While there remain elements to shuffle...
            while (currentIndex != 0) {

                // Pick a remaining element...
                let randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;

                // And swap it with the current element.
                [array[currentIndex], array[randomIndex]] = [
                    array[randomIndex], array[currentIndex]];
            }
        }

        function loadMegafilter() {
            let textarea = document.getElementById('sun_input');
            textarea.textContent = window.megafilter
            recompile()
        }

    </script>
</head>

<body>
    <h1>SUNSCRIPT Live Demo</h1>
    <p>
        This is not my best frontend work by far. This will be prettyfied later.
    </p>
    <p>
        Press to load the megafilter!
        <button onclick="loadMegafilter()">LOAD</button>
    </p>

    <textarea class="my_area" name="sun_input" id="sun_input">



alias c = char_count
c[1500:*] -> keep price=10BGC;>    // Keep all char_counts with 1500+ chars 
c[1460:*] -> sell price=1BGC;>     // Sell all char_counts with 1460+ chars
c         -> cull;>                // Destroy all other char_counts

--- // Next stage 

c keep _best=3 -> the_best     
c keep !the_best -> sell keep=undefined    // Only keep the best 3
c -> display            // Display all char_counts 

//This line does nothing on the parser side. It is specifically for the live demo.
//Display these properties:
//_COLUMNS_ i name _value cull keep sell price

    </textarea>

    <div id="table-container"></div>




    <script>


        let lib = SUN({ import: true })
        // console.log(SUN())
        // console.log(dataset) 

        //Uncomment to stress test
        // for (let i = 0; i < 3; i++) {
        //     dataset = dataset.concat(dataset)            
        // }



        for (const u of dataset) {
            u.special = lib.getUpgradeValue(u)
        }

        let timeoutId;
        let textarea = document.getElementById('sun_input');
        textarea.addEventListener('input', function () {
            // Clear previous timeout
            clearTimeout(timeoutId);

            // Set new timeout
            timeoutId = setTimeout(() => {
                recompile()
            }, 1000); // 1 second delay
        });

        var displayed = []
        let last = ""
        function recompile() {
            shuffle(dataset)

            let src = textarea.value
            displayed = JSON.parse(JSON.stringify(dataset))

            let columns = ["i", "name", "tier", "rarity", "_value"]

            //look for a //_COLUMNS_ line
            let st = src.indexOf('//_COLUMNS_')
            let ed = src.indexOf('\n', st)
            if (ed == -1) ed = src.length
            if (st != -1) {
                columns = src.substring(st, ed).replaceAll('//_COLUMNS_', '').trim().split(" ")
            }

            let charFilter = lib.compile(src)
            let result = lib.filter(displayed, charFilter)
            
            for (let i = 0; i < result.filtered.length; i++) {
                if (JSON.stringify(last[i]) != JSON.stringify(result.filtered[i])) {
                    console.log("UNEQUAL", last[i], result.filtered[i])
                }
            }
            last = JSON.parse(JSON.stringify(result.filtered));

            displayed = displayed.filter((a) => a.display)
            lib.sortUpgrades(displayed)

            console.log(result.filterTimes);
            console.log(result.filterTime);

            createTable(displayed, 'table-container', columns)
        }

        recompile()

        // setInterval(() => {
        //     recompile()
        // }, 3000);

    </script>

</body>

</html>